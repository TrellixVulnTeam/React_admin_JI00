{"ast":null,"code":"import \"antd/es/card/style\";\nimport _Card from \"antd/es/card\";\nimport \"antd/es/button/style\";\nimport _Button from \"antd/es/button\";\nimport \"antd/es/cascader/style\";\nimport _Cascader from \"antd/es/cascader\";\nimport \"antd/es/icon/style\";\nimport _Icon from \"antd/es/icon\";\nimport \"antd/es/message/style\";\nimport _message from \"antd/es/message\";\nimport \"antd/es/input/style\";\nimport _Input from \"antd/es/input\";\nimport \"antd/es/form/style\";\nimport _Form from \"antd/es/form\";\nvar _jsxFileName = \"C:\\\\Users\\\\itryl\\\\Desktop\\\\React client\\\\client\\\\src\\\\pages\\\\products\\\\add-update.jsx\";\nimport React, { Component } from 'react';\nimport LinkButton from '../../components/link-button';\nimport { reqCategorys, reqAddProductOrUpdateProduct } from '../../api/index';\nimport PictureWall from './pictures-wall';\nimport RichTextEditor from './rich-test-editor';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst Item = _Form.Item;\nconst {\n  TextArea\n} = _Input; //多行输入框\n//product的添加和更新的子路由组件\n\nclass ProductAddUpdate extends Component {\n  constructor(props) {\n    super(props); //创建用来保存ref标识的标签对象的容器\n\n    this.state = {\n      options: []\n    };\n\n    this.initOptions = async categorys => {\n      //根据categorys数组生成options数组\n      const options = categorys.map(c => {\n        return {\n          value: c._id,\n          label: c.name,\n          isLeaf: false //不是叶子\n\n        };\n      }); //如果是一个二级分类商品的更新\n\n      const {\n        isUpdate,\n        product\n      } = this;\n      const {\n        pCategoryId\n      } = product;\n\n      if (isUpdate && pCategoryId !== '0') {\n        //获取对应的二级分类列表\n        const subCategorys = await this.getCategorys(pCategoryId); //生成二级下拉列表的options\n\n        const childOptions = subCategorys.map(c => ({\n          value: c._id,\n          label: c.name,\n          isLeaf: true\n        })); //找到当前商品对应的一级option对象\n\n        const targetOption = options.find(option => option.value === pCategoryId); //关联到对应的一届options上\n\n        targetOption.children = childOptions;\n      } //更新状态\n\n\n      this.setState({\n        options\n      });\n    };\n\n    this.getCategorys = async parentId => {\n      const result = await reqCategorys(parentId);\n\n      if (result.status === 0) {\n        const categorys = result.data; //如果一级分类列表\n\n        if (parentId === '0') {\n          this.initOptions(categorys); //利用一级分类数组 调用生成options的数组\n        } else {\n            //二级分类列表\n            return categorys; //返回二级列表  当前async函数返回的promise就会成功且value为categorys\n          }\n      }\n    };\n\n    this.loadData = async selectedOptions => {\n      //得到选择的option对象\n      const targetOption = selectedOptions[0]; // 显示loading效果\n\n      targetOption.loading = true; //根据选中的分类，请求获取二级分类列表subCategorys\n\n      const subCategorys = await this.getCategorys(targetOption.value); //value是一级分类的id\n      // 隐藏loading效果\n\n      targetOption.loading = false;\n\n      if (subCategorys && subCategorys.length > 0) {\n        //当前选中的分类有二级分类\n        //生成一个二级列表的options\n        const cOptions = subCategorys.map(c => {\n          return {\n            value: c._id,\n            label: c.name,\n            isLeaf: true //是叶子\n\n          };\n        }); //关联到当前option上\n\n        targetOption.children = cOptions;\n      } else {\n        //当前选中的分类没有二级分类\n        targetOption.isLeaf = true;\n      }\n\n      this.setState({\n        options: [...this.state.options]\n      });\n    };\n\n    this.validatorPrice = (rule, value, callback) => {\n      //value是字符串类型\n      // callback()  //验证通过\n      // callback('xxxx')   //验证没通过  并且指定错误信息\n      if (value * 1 > 0) {\n        callback(); //验证通过\n      } else {\n        callback('价格必须大于0');\n      }\n    };\n\n    this.submit = () => {\n      //进行整体表单验证，整体通过才提交\n      this.props.form.validateFields(async (err, values) => {\n        // console.log(values.categoryIds,11111111111)\n        if (!err) {\n          //1.收集数据并封装成product对象\n          const {\n            name,\n            desc,\n            price,\n            categoryIds\n          } = values;\n          let pCategoryId, categoryId;\n\n          if (categoryIds.length === 1) {\n            pCategoryId = '0';\n            categoryId = categoryIds[0];\n          } else {\n            pCategoryId = categoryIds[0];\n            categoryId = categoryIds[1];\n          }\n\n          const imgs = this.pw.current.getImgs(); //得到上传图片的文件名数组\n\n          const detail = this.editor.current.getDetail(); //得到商品详情信息\n\n          const product = {\n            name,\n            desc,\n            price,\n            imgs,\n            detail\n          }; //如果是更新，需要添加_id\n\n          if (this.isUpdate) {\n            product._id = this.product._id;\n          } //2.调用接口请求函数去添加/更新\n\n\n          const result = await reqAddProductOrUpdateProduct(product); //3.根据结果提示\n\n          if (result.status === 0) {\n            _message.success(`${this.isUpdate ? '更新' : '添加'}商品成功！`);\n\n            this.props.history.goBack();\n          } else {\n            _message.error(`${this.isUpdate ? '更新' : '添加'}商品失败！`);\n          }\n        }\n      });\n    };\n\n    this.pw = /*#__PURE__*/React.createRef();\n    this.editor = /*#__PURE__*/React.createRef();\n  } //处理一级分类的数组\n\n\n  componentDidMount() {\n    this.getCategorys('0');\n  }\n\n  componentWillMount() {\n    //取出携带的state\n    const product = this.props.location.state; //如果添加没有值 ，否则有值 \n    //保存一个是否更新的标识\n\n    this.isUpdate = !!product; //保存商品  如果没有就保存一个空对象\n\n    this.product = product || {}; // ||{}空对象防止添加的时候没有值 而报错\n  }\n\n  render() {\n    //取出是否更新的标识\n    const {\n      isUpdate,\n      product\n    } = this;\n    const {\n      pCategoryId,\n      categoryId,\n      imgs,\n      detail\n    } = product; // console.log(pCategoryId,categoryId)\n    //用来接收级联分类id的数组\n\n    const categoryIds = []; //如果当前是更新\n\n    if (isUpdate) {\n      //商品是一个一级分类的商品\n      if (pCategoryId === '0') {\n        categoryIds.push(categoryId); // console.log(categoryIds,1111111111)\n      } else {\n        //商品是一个二级分类的商品\n        categoryIds.push(pCategoryId);\n        categoryIds.push(categoryId);\n      }\n    }\n\n    const title = /*#__PURE__*/_jsxDEV(\"span\", {\n      children: [/*#__PURE__*/_jsxDEV(LinkButton, {\n        onClick: () => {\n          this.props.history.goBack();\n        },\n        children: /*#__PURE__*/_jsxDEV(_Icon, {\n          type: \"arrow-left\",\n          style: {\n            fontSize: 20\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 169,\n          columnNumber: 21\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 168,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n        children: isUpdate ? '修改商品' : '添加商品'\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 171,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 167,\n      columnNumber: 13\n    }, this); //指定Item布局的配置对象\n\n\n    const formItemLayOut = {\n      labelCol: {\n        span: 2\n      },\n      //左侧label的宽度\n      wrapperCol: {\n        span: 8\n      } //指定右侧包裹的宽度\n\n    }; //输入框最后面的后缀\n\n    const selectAfter = /*#__PURE__*/_jsxDEV(\"span\", {\n      children: \"\\u5143\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 181,\n      columnNumber: 13\n    }, this); //获取表单验证\n\n\n    const {\n      getFieldDecorator\n    } = this.props.form;\n    return /*#__PURE__*/_jsxDEV(_Card, {\n      title: title,\n      children: /*#__PURE__*/_jsxDEV(_Form, { ...formItemLayOut,\n        children: [/*#__PURE__*/_jsxDEV(Item, {\n          label: \"\\u5546\\u54C1\\u540D\\u79F0\",\n          children: getFieldDecorator('name', {\n            initialValue: product.name,\n            rules: [{\n              required: true,\n              message: '必须输入商品名称'\n            }]\n          })( /*#__PURE__*/_jsxDEV(_Input, {\n            placeholder: \"\\u8BF7\\u8F93\\u5165\\u5546\\u54C1\\u540D\\u79F0\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 198,\n            columnNumber: 32\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 191,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Item, {\n          label: \"\\u5546\\u54C1\\u63CF\\u8FF0\",\n          children: getFieldDecorator('desc', {\n            initialValue: product.desc,\n            rules: [{\n              required: true,\n              message: '必须输入商品描述'\n            }]\n          })( /*#__PURE__*/_jsxDEV(TextArea, {\n            placeholder: \"\\u8BF7\\u8F93\\u5165\\u5546\\u54C1\\u63CF\\u8FF0\",\n            autosize: {\n              minRows: 2,\n              maxRows: 6\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 208,\n            columnNumber: 32\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 201,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Item, {\n          label: \"\\u5546\\u54C1\\u4EF7\\u683C\",\n          children: getFieldDecorator('price', {\n            initialValue: product.price,\n            rules: [{\n              required: true,\n              message: '必须输入商品价格'\n            }, {\n              validator: this.validatorPrice\n            }]\n          })( /*#__PURE__*/_jsxDEV(_Input, {\n            type: \"number\",\n            placeholder: \"\\u8BF7\\u8F93\\u5165\\u5546\\u54C1\\u4EF7\\u683C\",\n            addonAfter: selectAfter\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 219,\n            columnNumber: 32\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 211,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Item, {\n          label: \"\\u5546\\u54C1\\u5206\\u7C7B\",\n          children: getFieldDecorator('categorysIds', {\n            initialValue: categoryIds,\n            rules: [{\n              required: true,\n              message: '必须输入商品分类'\n            }]\n          })( /*#__PURE__*/_jsxDEV(_Cascader, {\n            placeholder: \"\\u8BF7\\u6307\\u5B9A\\u5546\\u54C1\\u5206\\u7C7B\",\n            options: this.state.options //需要显示的列表数据\n            ,\n            loadData: this.loadData //指定当选择某个列表项，加载下一级列表的监听回调\n\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 229,\n            columnNumber: 33\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 222,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Item, {\n          label: \"\\u5546\\u54C1\\u56FE\\u7247\",\n          children: /*#__PURE__*/_jsxDEV(PictureWall, {\n            ref: this.pw,\n            imgs: imgs\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 237,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 236,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Item, {\n          label: \"\\u5546\\u54C1\\u8BE6\\u60C5\",\n          children: /*#__PURE__*/_jsxDEV(RichTextEditor, {\n            ref: this.editor,\n            detail: detail\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 240,\n            columnNumber: 24\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 239,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Item, {\n          children: /*#__PURE__*/_jsxDEV(_Button, {\n            type: \"primary\",\n            onClick: this.submit,\n            children: \"\\u63D0\\u4EA4\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 243,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 242,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 190,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 187,\n      columnNumber: 13\n    }, this);\n  }\n\n}\n\nexport default _Form.create()(ProductAddUpdate);","map":{"version":3,"sources":["C:/Users/itryl/Desktop/React client/client/src/pages/products/add-update.jsx"],"names":["React","Component","LinkButton","reqCategorys","reqAddProductOrUpdateProduct","PictureWall","RichTextEditor","Item","TextArea","ProductAddUpdate","constructor","props","state","options","initOptions","categorys","map","c","value","_id","label","name","isLeaf","isUpdate","product","pCategoryId","subCategorys","getCategorys","childOptions","targetOption","find","option","children","setState","parentId","result","status","data","loadData","selectedOptions","loading","length","cOptions","validatorPrice","rule","callback","submit","form","validateFields","err","values","desc","price","categoryIds","categoryId","imgs","pw","current","getImgs","detail","editor","getDetail","success","history","goBack","error","createRef","componentDidMount","componentWillMount","location","render","push","title","fontSize","formItemLayOut","labelCol","span","wrapperCol","selectAfter","getFieldDecorator","initialValue","rules","required","message","minRows","maxRows","validator","create"],"mappings":"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","sourcesContent":["import React, { Component } from 'react'\r\nimport { Card, Icon, Input, Form, Cascader, Button, message } from 'antd'\r\nimport LinkButton from '../../components/link-button';\r\nimport {  reqCategorys,reqAddProductOrUpdateProduct } from '../../api/index'\r\nimport PictureWall from './pictures-wall'\r\nimport RichTextEditor from './rich-test-editor'\r\nconst Item = Form.Item\r\nconst { TextArea } = Input;  //多行输入框\r\n//product的添加和更新的子路由组件\r\nclass ProductAddUpdate extends Component {\r\n    state = {\r\n        options: [],\r\n    }\r\n    constructor(props){\r\n        super(props)\r\n        //创建用来保存ref标识的标签对象的容器\r\n        this.pw=React.createRef()\r\n        this.editor=React.createRef()\r\n    }\r\n    //处理一级分类的数组\r\n    initOptions =async(categorys) => {\r\n        //根据categorys数组生成options数组\r\n        const options = categorys.map((c) => {\r\n            return {\r\n                value: c._id,\r\n                label: c.name,\r\n                isLeaf: false  //不是叶子\r\n            }\r\n        })\r\n        //如果是一个二级分类商品的更新\r\n        const {isUpdate,product}=this\r\n        const {pCategoryId} =product\r\n        if(isUpdate&&pCategoryId!=='0'){\r\n            //获取对应的二级分类列表\r\n          const subCategorys=await  this.getCategorys(pCategoryId)\r\n          //生成二级下拉列表的options\r\n          const childOptions=subCategorys.map(c=>({\r\n                value:c._id,\r\n                label:c.name,\r\n                isLeaf:true\r\n          }))\r\n        //找到当前商品对应的一级option对象\r\n        const targetOption=options.find((option)=>option.value===pCategoryId)\r\n        //关联到对应的一届options上\r\n        targetOption.children=childOptions\r\n    }\r\n      //更新状态\r\n      this.setState({options})\r\n}\r\n    //获取一级分类列表 或者二级分类列表  二级分类数组有数据\r\n    getCategorys = async (parentId) => {\r\n        const result = await reqCategorys(parentId)\r\n        if (result.status === 0) {\r\n            const categorys = result.data\r\n            //如果一级分类列表\r\n            if (parentId === '0') {\r\n                this.initOptions(categorys)   //利用一级分类数组 调用生成options的数组\r\n            } else {  //二级分类列表\r\n                return categorys   //返回二级列表  当前async函数返回的promise就会成功且value为categorys\r\n            }\r\n        }\r\n    }\r\n    //用于加载下一级列表数据的回调\r\n    loadData = async selectedOptions => {\r\n        //得到选择的option对象\r\n        const targetOption = selectedOptions[0];\r\n        // 显示loading效果\r\n        targetOption.loading = true;\r\n\r\n        //根据选中的分类，请求获取二级分类列表subCategorys\r\n        const subCategorys = await this.getCategorys(targetOption.value)   //value是一级分类的id\r\n              // 隐藏loading效果\r\n              targetOption.loading = false;\r\n        if (subCategorys && subCategorys.length > 0) {  //当前选中的分类有二级分类\r\n            //生成一个二级列表的options\r\n        const cOptions=subCategorys.map(c=>{\r\n                return {\r\n                    value: c._id,\r\n                    label: c.name,\r\n                    isLeaf: true  //是叶子\r\n                }\r\n            })\r\n            //关联到当前option上\r\n            targetOption.children=cOptions\r\n        } else {  //当前选中的分类没有二级分类\r\n            targetOption.isLeaf=true\r\n        }\r\n        this.setState({\r\n            options: [...this.state.options]\r\n        });\r\n    };\r\n    //验证价格 自定义验证函数\r\n    validatorPrice = (rule, value, callback) => {   //value是字符串类型\r\n        // callback()  //验证通过\r\n        // callback('xxxx')   //验证没通过  并且指定错误信息\r\n        if (value * 1 > 0) {\r\n            callback() //验证通过\r\n        } else {\r\n            callback('价格必须大于0')\r\n        }\r\n    }\r\n    //提交按钮\r\n    submit = () => {\r\n        //进行整体表单验证，整体通过才提交\r\n        this.props.form.validateFields(async(err, values) => {\r\n            // console.log(values.categoryIds,11111111111)\r\n            if (!err) {\r\n            //1.收集数据并封装成product对象\r\n            const {name,desc,price,categoryIds}=values\r\n            let pCategoryId,categoryId\r\n            if(categoryIds.length===1){\r\n                pCategoryId='0'\r\n                categoryId=categoryIds[0]\r\n            }else{\r\n                pCategoryId=categoryIds[0]\r\n                categoryId=categoryIds[1]\r\n            }\r\n            const imgs=  this.pw.current.getImgs()  //得到上传图片的文件名数组\r\n            const detail=this.editor.current.getDetail()  //得到商品详情信息\r\n            const product={name,desc,price,imgs,detail, }\r\n            //如果是更新，需要添加_id\r\n            if(this.isUpdate){\r\n                product._id=this.product._id\r\n            }\r\n            //2.调用接口请求函数去添加/更新\r\n           const result=await reqAddProductOrUpdateProduct(product)\r\n            //3.根据结果提示\r\n            if(result.status===0){\r\n                message.success(`${this.isUpdate?'更新':'添加'}商品成功！`)\r\n                this.props.history.goBack()\r\n            }else{\r\n                message.error(`${this.isUpdate?'更新':'添加'}商品失败！`)\r\n            }\r\n            }\r\n        })\r\n    }\r\n    componentDidMount() {\r\n        this.getCategorys('0')\r\n    }\r\n    componentWillMount(){\r\n        //取出携带的state\r\n        const product=this.props.location.state  //如果添加没有值 ，否则有值 \r\n        //保存一个是否更新的标识\r\n        this.isUpdate=!!product\r\n        //保存商品  如果没有就保存一个空对象\r\n        this.product=product||{}  // ||{}空对象防止添加的时候没有值 而报错\r\n    }\r\n    render() {\r\n        //取出是否更新的标识\r\n        const {isUpdate,product} =this\r\n        const {pCategoryId,categoryId,imgs,detail}=product\r\n        // console.log(pCategoryId,categoryId)\r\n        //用来接收级联分类id的数组\r\n        const categoryIds=[]\r\n        //如果当前是更新\r\n        if(isUpdate){\r\n            //商品是一个一级分类的商品\r\n            if(pCategoryId==='0'){\r\n                categoryIds.push(categoryId)\r\n                // console.log(categoryIds,1111111111)\r\n            }else{  //商品是一个二级分类的商品\r\n                categoryIds.push(pCategoryId)\r\n                categoryIds.push(categoryId)\r\n            }\r\n        }\r\n        const title = (\r\n            <span>\r\n                <LinkButton onClick={()=>{this.props.history.goBack()}}>\r\n                    <Icon type='arrow-left' style={{ fontSize: 20 }}></Icon>\r\n                </LinkButton>\r\n                <span>{isUpdate?'修改商品':'添加商品'}</span>\r\n            </span>\r\n        )\r\n        //指定Item布局的配置对象\r\n        const formItemLayOut = {\r\n            labelCol: { span: 2 },   //左侧label的宽度\r\n            wrapperCol: { span: 8 }   //指定右侧包裹的宽度\r\n        }\r\n        //输入框最后面的后缀\r\n        const selectAfter = (\r\n            <span>元</span>\r\n        );\r\n\r\n        //获取表单验证\r\n        const { getFieldDecorator } = this.props.form\r\n        return (\r\n            <Card\r\n                title={title}\r\n            >\r\n                <Form {...formItemLayOut}>\r\n                    <Item label=\"商品名称\">\r\n                        {\r\n                            getFieldDecorator('name', {\r\n                                initialValue: product.name,\r\n                                rules: [\r\n                                    { required: true, message: '必须输入商品名称' }\r\n                                ]\r\n                            })(<Input placeholder='请输入商品名称'></Input>)\r\n                        }\r\n                    </Item>\r\n                    <Item label=\"商品描述\">\r\n                        {\r\n                            getFieldDecorator('desc', {\r\n                                initialValue: product.desc,\r\n                                rules: [\r\n                                    { required: true, message: '必须输入商品描述' }\r\n                                ]\r\n                            })(<TextArea placeholder='请输入商品描述' autosize={{ minRows: 2, maxRows: 6 }} ></TextArea>)\r\n                        }\r\n                    </Item>\r\n                    <Item label=\"商品价格\">\r\n                        {\r\n                            getFieldDecorator('price', {\r\n                                initialValue: product.price,\r\n                                rules: [\r\n                                    { required: true, message: '必须输入商品价格' },\r\n                                    { validator: this.validatorPrice }\r\n                                ]\r\n                            })(<Input type='number' placeholder='请输入商品价格' addonAfter={selectAfter}></Input>)\r\n                        }\r\n                    </Item>\r\n                    <Item label=\"商品分类\">\r\n                    {\r\n                            getFieldDecorator('categorysIds', {\r\n                                initialValue: categoryIds,\r\n                                rules: [\r\n                                    { required: true, message: '必须输入商品分类' },\r\n                                ]\r\n                            })( <Cascader\r\n                            placeholder='请指定商品分类'\r\n                                options={this.state.options}    //需要显示的列表数据\r\n                                loadData={this.loadData}        //指定当选择某个列表项，加载下一级列表的监听回调\r\n                            />)\r\n                        }\r\n                    </Item>\r\n                    <Item label=\"商品图片\">\r\n                        <PictureWall ref={this.pw} imgs={imgs}></PictureWall>\r\n                    </Item>\r\n                    <Item label=\"商品详情\">\r\n                       <RichTextEditor ref={this.editor} detail={detail}></RichTextEditor>\r\n                    </Item>\r\n                    <Item >\r\n                        <Button type='primary' onClick={this.submit}>提交</Button>\r\n                    </Item>\r\n                </Form>\r\n            </Card>\r\n        )\r\n    }\r\n}\r\nexport default Form.create()(ProductAddUpdate)\r\n"]},"metadata":{},"sourceType":"module"}